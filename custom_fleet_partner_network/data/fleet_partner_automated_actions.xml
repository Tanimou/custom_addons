<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">
        
        <!-- =================================================================
             AUTOMATED ACTIONS / SERVER ACTIONS FOR FLEET PARTNER NETWORK
             
             Ces actions automatisÃ©es rÃ©agissent aux changements de donnÃ©es
             pour dÃ©clencher des notifications, activitÃ©s et alertes.
             Utilise le trigger on_write avec filter_domain/filter_pre_domain
             pour une compatibilitÃ© maximale avec Odoo 19.
             ================================================================= -->
        
        <!-- ========== INCIDENT: STATE CHANGES ========== -->
        
        <!-- Action serveur: Notifier quand un incident passe en remorquage -->
        <record id="action_server_incident_towing" model="ir.actions.server">
            <field name="name">ğŸ“¢ Notification Incident en Remorquage</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Notifier le remorqueur et les managers quand un incident passe en remorquage
for incident in records:
    if incident.state != 'towing':
        continue
    
    # Get incident type label
    type_labels = dict(incident._fields['incident_type'].selection)
    incident_label = type_labels.get(incident.incident_type, 'Incident')
    
    # Build notification body
    body = f"""
    <h4>ğŸš› Remorquage AssignÃ©</h4>
    <p><strong>RÃ©fÃ©rence:</strong> {incident.reference}</p>
    <p><strong>VÃ©hicule:</strong> {incident.vehicle_id.name} ({incident.license_plate or '-'})</p>
    <p><strong>Type:</strong> {incident_label}</p>
    <p><strong>Lieu:</strong> {incident.incident_location or 'Non spÃ©cifiÃ©'}</p>
    <p><strong>Destination:</strong> {incident.towing_destination or 'Non spÃ©cifiÃ©e'}</p>
    """
    
    if incident.towing_scheduled_date:
        body += f"<p><strong>Date planifiÃ©e:</strong> {incident.towing_scheduled_date.strftime('%d/%m/%Y %H:%M')}</p>"
    
    # Notify towing partner
    if incident.towing_contact_id:
        env['mail.thread'].message_notify(
            partner_ids=incident.towing_contact_id.ids,
            body=body + "<p><em>Veuillez confirmer votre disponibilitÃ©.</em></p>",
            subject=f"ğŸš› Mission remorquage: {incident.reference}",
            model='fleet.incident.ticket',
            res_id=incident.id,
        )
    
    # Notify managers
    manager_group = env.ref('custom_fleet_partner_network.group_fleet_partner_manager', raise_if_not_found=False)
    if manager_group:
        managers = env['res.users'].search([
            ('group_ids', 'in', manager_group.ids),
            ('active', '=', True),
        ])
        for manager in managers:
            env['mail.thread'].message_notify(
                partner_ids=manager.partner_id.ids,
                body=body + f"<p><strong>Remorqueur:</strong> {incident.towing_partner_id.name if incident.towing_partner_id else '-'}</p>",
                subject=f"ğŸš› Incident en remorquage: {incident.reference}",
                model='fleet.incident.ticket',
                res_id=incident.id,
            )
    
    # Notify driver
    if incident.driver_id:
        env['mail.thread'].message_notify(
            partner_ids=incident.driver_id.ids,
            body=f"""
            <h4>ğŸš› Remorquage en cours</h4>
            <p>Votre vÃ©hicule <strong>{incident.vehicle_id.name}</strong> est pris en charge par le service de remorquage.</p>
            <p><strong>Destination:</strong> {incident.towing_destination or 'Ã€ confirmer'}</p>
            """,
            subject=f"ğŸš› Votre vÃ©hicule en remorquage",
            model='fleet.incident.ticket',
            res_id=incident.id,
        )
]]></field>
        </record>
        
        <!-- Action automatisÃ©e: DÃ©clencher quand incident passe Ã  "towing" -->
        <record id="base_automation_incident_towing" model="base.automation">
            <field name="name">ğŸ”” Incident PassÃ© en Remorquage</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('state', '=', 'towing')]</field>
            <field name="filter_pre_domain">[('state', '=', 'draft')]</field>
            <field name="action_server_ids" eval="[(4, ref('action_server_incident_towing'))]"/>
            <field name="active" eval="True"/>
        </record>
        
        
        <!-- Action serveur: Notifier quand un incident passe en rÃ©paration -->
        <record id="action_server_incident_repair" model="ir.actions.server">
            <field name="name">ğŸ“¢ Notification Incident en RÃ©paration</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Notifier le garage et crÃ©er des activitÃ©s quand un incident passe en rÃ©paration
for incident in records:
    if incident.state != 'repair':
        continue
    
    # Get incident type label
    type_labels = dict(incident._fields['incident_type'].selection)
    incident_label = type_labels.get(incident.incident_type, 'Incident')
    
    body = f"""
    <h4>ğŸ”§ RÃ©paration DÃ©marrÃ©e</h4>
    <p><strong>RÃ©fÃ©rence:</strong> {incident.reference}</p>
    <p><strong>VÃ©hicule:</strong> {incident.vehicle_id.name} ({incident.license_plate or '-'})</p>
    <p><strong>Type:</strong> {incident_label}</p>
    <p><strong>Date dÃ©but:</strong> {incident.repair_start_date.strftime('%d/%m/%Y') if incident.repair_start_date else "Aujourd'hui"}</p>
    """
    
    if incident.estimated_repair_cost:
        body += f"<p><strong>CoÃ»t estimÃ©:</strong> {incident.estimated_repair_cost:.2f} {incident.currency_id.symbol or 'â‚¬'}</p>"
    
    # Notify garage partner
    if incident.garage_contact_id:
        env['mail.thread'].message_notify(
            partner_ids=incident.garage_contact_id.ids,
            body=body + "<p><em>Merci de nous tenir informÃ©s de l'avancement.</em></p>",
            subject=f"ğŸ”§ VÃ©hicule en rÃ©paration: {incident.reference}",
            model='fleet.incident.ticket',
            res_id=incident.id,
        )
        
        # Create activity for garage follow-up
        if incident.responsible_id:
            incident.activity_schedule(
                'mail.mail_activity_data_todo',
                user_id=incident.responsible_id.id,
                summary=f"ğŸ“ Suivi rÃ©paration: {incident.reference}",
                note=f"Contacter le garage {incident.garage_partner_id.name if incident.garage_partner_id else ''} "
                     f"pour le suivi de la rÃ©paration du vÃ©hicule {incident.vehicle_id.name}.",
                date_deadline=datetime.date.today() + datetime.timedelta(days=3),
            )
    
    # Notify managers
    manager_group = env.ref('custom_fleet_partner_network.group_fleet_partner_manager', raise_if_not_found=False)
    if manager_group:
        managers = env['res.users'].search([
            ('group_ids', 'in', manager_group.ids),
            ('active', '=', True),
        ])
        for manager in managers:
            env['mail.thread'].message_notify(
                partner_ids=manager.partner_id.ids,
                body=body + f"<p><strong>Garage:</strong> {incident.garage_partner_id.name if incident.garage_partner_id else '-'}</p>",
                subject=f"ğŸ”§ Incident en rÃ©paration: {incident.reference}",
                model='fleet.incident.ticket',
                res_id=incident.id,
            )
    
    # Post in vehicle chatter
    if incident.vehicle_id:
        incident.vehicle_id.message_post(
            body=f"""
            <p>ğŸ”§ <strong>RÃ©paration dÃ©marrÃ©e</strong></p>
            <ul>
                <li>Incident: <a href="#" data-oe-model="fleet.incident.ticket" data-oe-id="{incident.id}">{incident.reference}</a></li>
                <li>Garage: {incident.garage_partner_id.name if incident.garage_partner_id else '-'}</li>
            </ul>
            """,
            message_type='notification',
            subtype_xmlid='mail.mt_note',
        )
]]></field>
        </record>
        
        <!-- Action automatisÃ©e: DÃ©clencher quand incident passe Ã  "repair" -->
        <record id="base_automation_incident_repair" model="base.automation">
            <field name="name">ğŸ”” Incident PassÃ© en RÃ©paration</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('state', '=', 'repair')]</field>
            <field name="filter_pre_domain">[('state', '=', 'towing')]</field>
            <field name="action_server_ids" eval="[(4, ref('action_server_incident_repair'))]"/>
            <field name="active" eval="True"/>
        </record>
        
        
        <!-- Action serveur: Notifier quand un incident est clÃ´turÃ© -->
        <record id="action_server_incident_closed" model="ir.actions.server">
            <field name="name">ğŸ“¢ Notification Incident ClÃ´turÃ©</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Notifier tous les stakeholders quand un incident est clÃ´turÃ©
for incident in records:
    if incident.state != 'closed':
        continue
    
    # Get incident type label
    type_labels = dict(incident._fields['incident_type'].selection)
    incident_label = type_labels.get(incident.incident_type, 'Incident')
    
    # Calculate total cost
    total_cost = incident.total_actual_cost or 0
    currency = incident.currency_id.symbol or 'â‚¬'
    
    body = f"""
    <h4>âœ… Incident ClÃ´turÃ©</h4>
    <p><strong>RÃ©fÃ©rence:</strong> {incident.reference}</p>
    <p><strong>VÃ©hicule:</strong> {incident.vehicle_id.name} ({incident.license_plate or '-'})</p>
    <p><strong>Type:</strong> {incident_label}</p>
    <p><strong>CoÃ»t total:</strong> {total_cost:.2f} {currency}</p>
    <ul>
        <li>Remorquage: {(incident.actual_towing_cost or 0):.2f} {currency}</li>
        <li>RÃ©paration: {(incident.actual_repair_cost or 0):.2f} {currency}</li>
    </ul>
    """
    
    if incident.close_notes:
        body += f"<p><strong>Notes:</strong> {incident.close_notes}</p>"
    
    # Notify managers
    manager_group = env.ref('custom_fleet_partner_network.group_fleet_partner_manager', raise_if_not_found=False)
    if manager_group:
        managers = env['res.users'].search([
            ('group_ids', 'in', manager_group.ids),
            ('active', '=', True),
        ])
        for manager in managers:
            env['mail.thread'].message_notify(
                partner_ids=manager.partner_id.ids,
                body=body + "<p><em>Le vÃ©hicule est de nouveau disponible.</em></p>",
                subject=f"âœ… Incident clÃ´turÃ©: {incident.reference} - CoÃ»t: {total_cost:.2f} {currency}",
                model='fleet.incident.ticket',
                res_id=incident.id,
            )
    
    # Notify driver
    if incident.driver_id:
        env['mail.thread'].message_notify(
            partner_ids=incident.driver_id.ids,
            body=f"""
            <h4>âœ… Votre vÃ©hicule est prÃªt</h4>
            <p>L'incident <strong>{incident.reference}</strong> concernant le vÃ©hicule 
               <strong>{incident.vehicle_id.name}</strong> a Ã©tÃ© rÃ©solu.</p>
            <p>Le vÃ©hicule est de nouveau disponible.</p>
            """,
            subject=f"âœ… VÃ©hicule disponible: {incident.vehicle_id.name}",
            model='fleet.incident.ticket',
            res_id=incident.id,
        )
    
    # Close related activities
    incident.activity_ids.filtered(lambda a: a.state != 'done').action_done()
    
    # Post in vehicle chatter
    if incident.vehicle_id:
        incident.vehicle_id.message_post(
            body=f"""
            <p>âœ… <strong>Incident rÃ©solu</strong></p>
            <ul>
                <li>RÃ©fÃ©rence: <a href="#" data-oe-model="fleet.incident.ticket" data-oe-id="{incident.id}">{incident.reference}</a></li>
                <li>CoÃ»t total: {total_cost:.2f} {currency}</li>
            </ul>
            """,
            message_type='notification',
            subtype_xmlid='mail.mt_note',
        )
]]></field>
        </record>
        
        <!-- Action automatisÃ©e: DÃ©clencher quand incident passe Ã  "closed" -->
        <record id="base_automation_incident_closed" model="base.automation">
            <field name="name">ğŸ”” Incident ClÃ´turÃ©</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('state', '=', 'closed')]</field>
            <field name="filter_pre_domain">[('state', 'in', ['towing', 'repair'])]</field>
            <field name="action_server_ids" eval="[(4, ref('action_server_incident_closed'))]"/>
            <field name="active" eval="True"/>
        </record>
        
        
        <!-- Action serveur: Notifier quand un incident est annulÃ© -->
        <record id="action_server_incident_cancelled" model="ir.actions.server">
            <field name="name">ğŸ“¢ Notification Incident AnnulÃ©</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Nettoyer les activitÃ©s et notifier quand un incident est annulÃ©
for incident in records:
    if incident.state != 'cancelled':
        continue
    
    body = f"""
    <h4>âŒ Incident AnnulÃ©</h4>
    <p><strong>RÃ©fÃ©rence:</strong> {incident.reference}</p>
    <p><strong>VÃ©hicule:</strong> {incident.vehicle_id.name}</p>
    <p><em>Cet incident a Ã©tÃ© annulÃ©.</em></p>
    """
    
    # Notify responsible
    if incident.responsible_id and incident.responsible_id.partner_id:
        env['mail.thread'].message_notify(
            partner_ids=incident.responsible_id.partner_id.ids,
            body=body,
            subject=f"âŒ Incident annulÃ©: {incident.reference}",
            model='fleet.incident.ticket',
            res_id=incident.id,
        )
    
    # Notify towing partner if was assigned
    if incident.towing_contact_id:
        env['mail.thread'].message_notify(
            partner_ids=incident.towing_contact_id.ids,
            body=body + "<p><em>La mission de remorquage est annulÃ©e.</em></p>",
            subject=f"âŒ Annulation mission remorquage: {incident.reference}",
            model='fleet.incident.ticket',
            res_id=incident.id,
        )
    
    # Notify garage if was assigned
    if incident.garage_contact_id:
        env['mail.thread'].message_notify(
            partner_ids=incident.garage_contact_id.ids,
            body=body + "<p><em>La rÃ©paration est annulÃ©e.</em></p>",
            subject=f"âŒ Annulation rÃ©paration: {incident.reference}",
            model='fleet.incident.ticket',
            res_id=incident.id,
        )
    
    # Delete related activities
    incident.activity_ids.unlink()
]]></field>
        </record>
        
        <!-- Action automatisÃ©e: DÃ©clencher quand incident passe Ã  "cancelled" -->
        <record id="base_automation_incident_cancelled" model="base.automation">
            <field name="name">ğŸ”” Incident AnnulÃ©</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('state', '=', 'cancelled')]</field>
            <field name="filter_pre_domain">[('state', 'in', ['draft', 'towing', 'repair'])]</field>
            <field name="action_server_ids" eval="[(4, ref('action_server_incident_cancelled'))]"/>
            <field name="active" eval="True"/>
        </record>
        
        
        <!-- ========== INCIDENT: PRIORITY ESCALATION ========== -->
        
        <!-- Action serveur: Escalade pour prioritÃ© haute/critique -->
        <record id="action_server_incident_priority_escalation" model="ir.actions.server">
            <field name="name">ğŸ“¢ Escalade Incident PrioritÃ© Haute</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Escalader les incidents haute prioritÃ© aux managers
for incident in records:
    if incident.priority not in ('2', '3'):
        continue
    
    priority_labels = {'2': 'Urgente', '3': 'Critique'}
    priority_icons = {'2': 'ğŸŸ ', '3': 'ğŸ”´'}
    
    # Get incident type label
    type_labels = dict(incident._fields['incident_type'].selection)
    incident_label = type_labels.get(incident.incident_type, 'Incident')
    state_label = dict(incident._fields['state'].selection).get(incident.state, '')
    
    body = f"""
    <h4>{priority_icons.get(incident.priority, 'âš ï¸')} ESCALADE - PrioritÃ© {priority_labels.get(incident.priority, 'Haute')}</h4>
    <p><strong>RÃ©fÃ©rence:</strong> {incident.reference}</p>
    <p><strong>VÃ©hicule:</strong> {incident.vehicle_id.name} ({incident.license_plate or '-'})</p>
    <p><strong>Type:</strong> {incident_label}</p>
    <p><strong>Ã‰tat:</strong> {state_label}</p>
    <p><strong>Responsable:</strong> {incident.responsible_id.name if incident.responsible_id else '-'}</p>
    <p><em>âš ï¸ Cet incident nÃ©cessite une attention immÃ©diate!</em></p>
    """
    
    # Notify managers
    manager_group = env.ref('custom_fleet_partner_network.group_fleet_partner_manager', raise_if_not_found=False)
    if manager_group:
        managers = env['res.users'].search([
            ('group_ids', 'in', manager_group.ids),
            ('active', '=', True),
        ])
        for manager in managers:
            env['mail.thread'].message_notify(
                partner_ids=manager.partner_id.ids,
                body=body,
                subject=f"{priority_icons.get(incident.priority, 'âš ï¸')} URGENT: {incident.reference}",
                model='fleet.incident.ticket',
                res_id=incident.id,
            )
            
            # Create urgent activity
            if incident.priority == '3':  # Critical
                incident.activity_schedule(
                    'mail.mail_activity_data_todo',
                    user_id=manager.id,
                    summary=f"ğŸ”´ CRITIQUE: {incident.reference}",
                    note=f"Incident critique nÃ©cessitant une action immÃ©diate.\n"
                         f"VÃ©hicule: {incident.vehicle_id.name}\n"
                         f"Type: {incident_label}",
                    date_deadline=datetime.date.today(),
                )
]]></field>
        </record>
        
        <!-- Action automatisÃ©e: DÃ©clencher sur changement de prioritÃ© haute -->
        <record id="base_automation_incident_priority" model="base.automation">
            <field name="name">ğŸ”” Escalade PrioritÃ© Haute/Critique</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('priority', 'in', ['2', '3'])]</field>
            <field name="filter_pre_domain">[('priority', 'in', ['0', '1'])]</field>
            <field name="action_server_ids" eval="[(4, ref('action_server_incident_priority_escalation'))]"/>
            <field name="active" eval="True"/>
        </record>
        
        
        <!-- ========== PARTNER PROFILE: EXPIRATION/STATUS ========== -->
        
        <!-- Action serveur: Alerte quand un partenaire n'est plus approuvÃ© -->
        <record id="action_server_partner_unapproved" model="ir.actions.server">
            <field name="name">ğŸ“¢ Alerte Partenaire Non ApprouvÃ©</field>
            <field name="model_id" ref="model_fleet_partner_profile"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Alerter quand un partenaire perd son approbation
for profile in records:
    if profile.supplier_approved:
        continue  # Still approved, skip
    
    type_labels = {'assureur': 'Assureur', 'garage': 'Garage AgrÃ©Ã©', 'remorqueur': 'Remorqueur'}
    type_label = type_labels.get(profile.partner_type, profile.partner_type or '')
    
    body = f"""
    <h4>âš ï¸ Partenaire Non ApprouvÃ©</h4>
    <p><strong>Profil:</strong> {profile.name}</p>
    <p><strong>Partenaire:</strong> {profile.partner_id.name}</p>
    <p><strong>Type:</strong> {type_label}</p>
    <p><em>Ce partenaire n'est plus dans la liste des fournisseurs approuvÃ©s.
    Les incidents ne pourront plus lui Ãªtre assignÃ©s.</em></p>
    """
    
    # Notify managers
    manager_group = env.ref('custom_fleet_partner_network.group_fleet_partner_manager', raise_if_not_found=False)
    if manager_group:
        managers = env['res.users'].search([
            ('group_ids', 'in', manager_group.ids),
            ('active', '=', True),
        ])
        for manager in managers:
            env['mail.thread'].message_notify(
                partner_ids=manager.partner_id.ids,
                body=body,
                subject=f"âš ï¸ Partenaire non approuvÃ©: {profile.partner_id.name}",
                model='fleet.partner.profile',
                res_id=profile.id,
            )
            
            # Create activity
            profile.activity_schedule(
                'mail.mail_activity_data_todo',
                user_id=manager.id,
                summary=f"âš ï¸ RÃ©viser partenaire: {profile.name}",
                note=f"Le partenaire {profile.partner_id.name} n'est plus approuvÃ©.\n"
                     f"Veuillez mettre Ã  jour les assignments d'incidents en cours.",
                date_deadline=datetime.date.today() + datetime.timedelta(days=3),
            )
]]></field>
        </record>
        
        <!-- Action automatisÃ©e: DÃ©clencher quand supplier_approved devient False -->
        <record id="base_automation_partner_unapproved" model="base.automation">
            <field name="name">ğŸ”” Partenaire Non ApprouvÃ©</field>
            <field name="model_id" ref="model_fleet_partner_profile"/>
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('supplier_approved', '=', False)]</field>
            <field name="filter_pre_domain">[('supplier_approved', '=', True)]</field>
            <field name="action_server_ids" eval="[(4, ref('action_server_partner_unapproved'))]"/>
            <field name="active" eval="True"/>
        </record>
        
        
        <!-- ========== INCIDENT: ACCIDENT TYPE SPECIAL HANDLING ========== -->
        
        <!-- Action serveur: Notification spÃ©ciale pour accidents -->
        <record id="action_server_incident_accident" model="ir.actions.server">
            <field name="name">ğŸ“¢ Notification Accident</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Notification spÃ©ciale pour les accidents - inclut l'assureur
for incident in records:
    if incident.incident_type != 'accident':
        continue
    
    body = f"""
    <h4>ğŸš¨ Nouvel Accident SignalÃ©</h4>
    <p><strong>RÃ©fÃ©rence:</strong> {incident.reference}</p>
    <p><strong>VÃ©hicule:</strong> {incident.vehicle_id.name} ({incident.license_plate or '-'})</p>
    <p><strong>Conducteur:</strong> {incident.driver_id.name if incident.driver_id else '-'}</p>
    <p><strong>Date:</strong> {incident.incident_date.strftime('%d/%m/%Y %H:%M') if incident.incident_date else '-'}</p>
    <p><strong>Lieu:</strong> {incident.incident_location or 'Non spÃ©cifiÃ©'}</p>
    """
    
    # Notify insurance partner if assigned
    if incident.insurance_partner_id and incident.insurance_partner_id.partner_id:
        env['mail.thread'].message_notify(
            partner_ids=incident.insurance_partner_id.partner_id.ids,
            body=body + """
            <p><em>Merci de nous contacter pour la dÃ©claration de sinistre.</em></p>
            """,
            subject=f"ğŸš¨ DÃ©claration accident: {incident.reference}",
            model='fleet.incident.ticket',
            res_id=incident.id,
        )
    
    # Always notify managers for accidents
    manager_group = env.ref('custom_fleet_partner_network.group_fleet_partner_manager', raise_if_not_found=False)
    if manager_group:
        managers = env['res.users'].search([
            ('group_ids', 'in', manager_group.ids),
            ('active', '=', True),
        ])
        for manager in managers:
            env['mail.thread'].message_notify(
                partner_ids=manager.partner_id.ids,
                body=body + f"""
                <p><strong>Assureur:</strong> {incident.insurance_partner_id.name if incident.insurance_partner_id else 'Non assignÃ©'}</p>
                <p><em>âš ï¸ Un accident a Ã©tÃ© signalÃ©. Veuillez assurer le suivi.</em></p>
                """,
                subject=f"ğŸš¨ ACCIDENT: {incident.reference} - {incident.vehicle_id.name}",
                model='fleet.incident.ticket',
                res_id=incident.id,
            )
            
            # Create urgent activity for accident follow-up
            incident.activity_schedule(
                'mail.mail_activity_data_todo',
                user_id=manager.id,
                summary=f"ğŸš¨ Suivi accident: {incident.reference}",
                note=f"Un accident a Ã©tÃ© signalÃ©.\n"
                     f"VÃ©hicule: {incident.vehicle_id.name}\n"
                     f"Conducteur: {incident.driver_id.name if incident.driver_id else '-'}\n"
                     f"VÃ©rifier la dÃ©claration auprÃ¨s de l'assureur.",
                date_deadline=datetime.date.today(),
            )
]]></field>
        </record>
        
        <!-- Action automatisÃ©e: DÃ©clencher pour nouveaux accidents -->
        <record id="base_automation_incident_accident" model="base.automation">
            <field name="name">ğŸ”” Nouvel Accident SignalÃ©</field>
            <field name="model_id" ref="model_fleet_incident_ticket"/>
            <field name="trigger">on_create</field>
            <field name="filter_domain">[('incident_type', '=', 'accident')]</field>
            <field name="action_server_ids" eval="[(4, ref('action_server_incident_accident'))]"/>
            <field name="active" eval="True"/>
        </record>
        
    </data>
</odoo>
