<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- ========== INTERVENTION FORM EXTENSION: DOWNTIME + TECHNICIAN TIME ========== -->
    
    <!-- Extend intervention form to show downtime KPIs -->
    <record id="fleet_maintenance_intervention_view_form_downtime" model="ir.ui.view">
        <field name="name">fleet.maintenance.intervention.view.form.downtime</field>
        <field name="model">fleet.maintenance.intervention</field>
        <field name="inherit_id" ref="custom_fleet_maintenance.fleet_maintenance_intervention_view_form"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            
            <!-- Add button box at top of sheet -->
            <xpath expr="//sheet" position="inside">
                <div name="button_box" class="oe_button_box" style="position: absolute; top: 0; right: 0;">
                    <button class="oe_stat_button" type="object" 
                            name="action_view_technician_time"
                            icon="fa-clock-o"
                            invisible="technician_count == 0">
                        <field name="total_technician_hours" widget="statinfo" string="Heures Tech."/>
                    </button>
                </div>
            </xpath>
            
            <!-- Add downtime fields after odometer field -->
            <xpath expr="//field[@name='odometer']" position="after">
                <field name="downtime_hours" readonly="1" widget="float_time" string="Temps d'arrêt (h)"/>
                <field name="downtime_days" readonly="1"/>
                <field name="total_technician_hours" readonly="1" widget="float_time"/>
                <field name="technician_count" readonly="1" invisible="1"/>
            </xpath>
            
            <!-- Add technician time notebook page -->
            <xpath expr="//notebook" position="inside">
                <page string="Temps Techniciens" name="technician_time">
                    <field name="technician_time_ids" mode="list,form">
                        <list string="Temps Techniciens" editable="bottom">
                            <field name="date"/>
                            <field name="technician_id"/>
                            <field name="work_type"/>
                            <field name="hours" sum="Total"/>
                            <field name="description" optional="show"/>
                        </list>
                        <form string="Temps Technicien">
                            <group>
                                <group>
                                    <field name="date"/>
                                    <field name="technician_id"/>
                                    <field name="hours"/>
                                </group>
                                <group>
                                    <field name="work_type"/>
                                </group>
                            </group>
                            <group>
                                <field name="description"/>
                            </group>
                        </form>
                    </field>
                </page>
            </xpath>
            
        </field>
    </record>
    
    <!-- Extend intervention tree to show downtime -->
    <record id="fleet_maintenance_intervention_view_tree_downtime" model="ir.ui.view">
        <field name="name">fleet.maintenance.intervention.view.tree.downtime</field>
        <field name="model">fleet.maintenance.intervention</field>
        <field name="inherit_id" ref="custom_fleet_maintenance.fleet_maintenance_intervention_view_tree"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            
            <!-- Add downtime columns -->
            <xpath expr="//field[@name='state']" position="before">
                <field name="downtime_hours" string="Arrêt (h)" optional="show" widget="float_time"/>
                <field name="total_technician_hours" string="Tech. (h)" optional="hide" widget="float_time"/>
            </xpath>
            
        </field>
    </record>
    
    <!-- Extend intervention search to add downtime group-by -->
    <record id="fleet_maintenance_intervention_view_search_downtime" model="ir.ui.view">
        <field name="name">fleet.maintenance.intervention.view.search.downtime</field>
        <field name="model">fleet.maintenance.intervention</field>
        <field name="inherit_id" ref="custom_fleet_maintenance.fleet_maintenance_intervention_view_search"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            
            <!-- Add high downtime filter after existing filters -->
            <xpath expr="//filter[@name='has_po']" position="after">
                <separator/>
                <filter name="filter_high_downtime" string="Arrêt > 8h" domain="[('downtime_hours', '>', 8)]"/>
            </xpath>
            
        </field>
    </record>
    
</odoo>
