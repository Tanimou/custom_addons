<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
    <!-- 
        Extend OrderReceipt to show loyalty points balance when "Carte de fidélité" payment method is used.
        Shows:
        - Ancien solde (old balance before payment)
        - Dépensé (amount paid via loyalty)
        - Nouveau solde (new balance after payment)
    -->
    <t t-name="custom_loyalty.OrderReceiptLoyaltyBalance" t-inherit="point_of_sale.OrderReceipt" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('before-footer')]" position="before">
            <!-- 
                Show loyalty balance only when:
                1. Partner is selected (order.partner_id)
                2. Carte de fidélité payment method was used (is_loyalty flag)
            -->
            <t t-set="loyaltyPayment" t-value="paymentLines.find(line => line.payment_method_id.is_loyalty)"/>
            <t t-if="order.partner_id and loyaltyPayment">
                <!-- 
                    Get loyalty card for this partner from the models cache.
                    The cached points value represents the balance BEFORE the payment was synced to server.
                -->
                <t t-set="loyaltyCards" t-value="order.models and order.models['loyalty.card']"/>
                <t t-set="partnerLoyaltyCard" t-value="loyaltyCards and loyaltyCards.find(card => card.partner_id?.id === order.partner_id.id || card.partner_id === order.partner_id.id)"/>
                <t t-if="partnerLoyaltyCard">
                    <!-- Calculate balances -->
                    <t t-set="loyaltySpent" t-value="loyaltyPayment.getAmount()"/>
                    <!-- 
                        The cached card.points is the OLD balance (before server sync).
                        New balance = Old balance - Spent
                    -->
                    <t t-set="ancienSolde" t-value="partnerLoyaltyCard.points || 0"/>
                    <t t-set="nouveauSolde" t-value="ancienSolde - loyaltySpent"/>
                    
                    <div class="pos-receipt-loyalty-balance text-start pt-2" style="font-size: 85%; border-top: 1px dashed #ccc; margin-top: 8px; padding-top: 8px;">
                        <div class="fw-bold mb-1" style="font-size: 95%;">Fidélité</div>
                        <div class="d-flex justify-content-between">
                            <span>Ancien solde:</span>
                            <span t-out="formatCurrency(ancienSolde)" class="font-monospace"/>
                        </div>
                        <div class="d-flex justify-content-between text-danger">
                            <span>Dépensé:</span>
                            <span t-out="formatCurrency(loyaltySpent)" class="font-monospace"/>
                        </div>
                        <div class="d-flex justify-content-between fw-bold" style="border-top: 1px solid #ccc; padding-top: 4px; margin-top: 4px;">
                            <span>Nouveau solde:</span>
                            <span t-out="formatCurrency(nouveauSolde)" class="font-monospace"/>
                        </div>
                    </div>
                </t>
            </t>
        </xpath>
    </t>
</templates>
