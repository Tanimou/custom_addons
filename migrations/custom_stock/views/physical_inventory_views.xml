<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vue formulaire Code Inventaire -->
        <record id="view_physical_inventory_form" model="ir.ui.view">
            <field name="name">physical.inventory.form</field>
            <field name="model">physical.inventory</field>
            <field name="arch" type="xml">
                <form string="Inventaire Journalier" create="0" edit="1">
                    <header>
                        <button name="action_start" type="object" string="Soumettre pour validation"
                                class="btn-primary" invisible="state != 'draft'"/>
                        <button name="action_done"
                                type="object"
                                string="Valider l'inventaire"
                                class="btn-primary"
                                groups="custom_pos.group_pos_shop"
                                invisible="state != 'in_progress'"/>

                        <button name="action_draft" type="object" string="Annuler"
                                class="btn-secondary" invisible="state != 'in_progress'"/>
                        <button name="action_print_inventaire_report"
                                string="Imprimer Inventaire"
                                type="object"
                                class="btn-primary"
                                icon="fa-print"
                                invisible="state != 'done'"
                        />
                        <button name="action_print_inventaire_report_decompte"
                                string="Imprimer fiche de comptage"
                                type="object"
                                class="btn-primary"
                                icon="fa-print"
                                invisible="state != 'draft'"
                        />
                        <field name="state" widget="statusbar" statusbar_visible="draft,in_progress,done"
                        />
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1>
                                <field name="name" placeholder="Nom" readonly="state == 'done'"/>
                            </h1>
                        </div>
                        <div id="unverified_reminder" class="alert alert-info" role="alert" invisible="inventory_mode != 'verification_carryover' or unverified_product_count == 0">
                            <strong>Rappel:</strong> <field name="unverified_product_count" readonly="1" nolabel="1"/> produit(s) à vérifier de session(s) antérieure(s).
                        </div>
                        <group>
                            <group>
                                <field name="inventory_mode" readonly="state != 'draft'"/>
                                <field name="code_category_id" 
                                       invisible="inventory_mode == 'verification_carryover'" 
                                       required="inventory_mode == 'normal'"
                                       readonly="state == 'done'"/>
                                <field name="code_inventory_id"
                                       widget="many2many_tags"
                                       invisible="inventory_mode == 'verification_carryover'"
                                       required="inventory_mode == 'normal'"
                                       domain="[('code_category_id', '=', code_category_id)]"
                                       readonly="state == 'done'"/>
                                <field name="team_inventory_id" 
                                       invisible="inventory_mode == 'verification_carryover'" 
                                       required="inventory_mode == 'normal'"
                                       readonly="state == 'done'"/>
                                <field name="unverified_product_count"/>
                            </group>
                            <group>
                                <field name="date" readonly="state == 'done'"/>
                                <field name="date_done"/>
                                <field name="is_negative_stock" invisible="1"/>
                                <field name="company_id"/>
                            </group>
                        </group>
                        <group>
                            <button name="create_line_physical"
                                    string="Generer les articles"
                                    type="object"
                                    invisible="state != 'draft' or inventory_mode == 'verification_carryover'"
                                    class="btn btn-success"/>
                            <button name="create_line_physical"
                                    string="Generer les produits à vérifer"
                                    type="object"
                                    invisible="state != 'draft' or inventory_mode != 'verification_carryover'"
                                    class="btn btn-success"/>
                        </group>
                        <notebook>
                            <page string="Ligne Inventaire Physique">
                                <field name="physical_line_ids" readonly="state == 'done'"
                                       domain="[('active', '=', True)]">
                                    <list editable="bottom" create="0" edit="1" delete="0">
                                        <field name="code_inventory_id" column_invisible="False"/>
                                        <field name="state" column_invisible="1"/>
                                        <field name="code_category_id" column_invisible="True"/>
                                        <field name="inventory_physical_id" column_invisible="True"/>
                                        <field name="quant_id" column_invisible="True"/>
                                        <field name="product_id" column_invisible="True"/>
                                        <field name="location_id" column_invisible="False"/>
                                        <field name="product_tmpl_id" column_invisible="False"/>
                                        <field name="quantity" invisible="state == 'draft'"/>
                                        <field name="product_uom_id" column_invisible="False"/>
                                        <field name="physical_qty" column_invisible="False"/>
                                        <field name="qty_diff" string="Difference" invisible="state == 'draft'"
                                               decoration-muted="qty_diff == 0" decoration-danger="qty_diff &lt; 0"
                                               decoration-success="qty_diff &gt; 0" decoration-bf="qty_diff != 0"/>
                                        <field name="standard_price" string="Prix unitaire (PMP)"
                                               invisible="state == 'draft'"/>
                                        <field name="valorisation" string="Valorisation" invisible="state == 'draft'"/>
                                        <field name="active" column_invisible="1"/>
                                        <field name="needs_verification" column_invisible="False"/>
                                        <field name="verified_by_id" string="Vérifié par" options="{'no_create': True}"/>

                                        <button name="action_archive_line" type="object"
                                                string="Retirer la ligne" icon="fa-archive"
                                                class="btn-warning"
                                                invisible="state != 'in_progress'"
                                                confirm="Voulez-vous vraiment retirer cette ligne ?"/>
                                    </list>
                                </field>
                            </page>

                            <page name="achive_line" string="A vérifier">
                                <field name="physical_achive_line_ids">
                                    <list create="0" edit="0" delete="0">
                                        <field name="quant_id" column_invisible="True"/>
                                        <field name="product_id" column_invisible="True"/>
                                        <field name="location_id" column_invisible="False"/>
                                        <field name="product_tmpl_id" column_invisible="False"/>
                                        <field name="quantity"/>
                                        <field name="product_uom_id" column_invisible="False"/>
                                        <field name="physical_qty" column_invisible="False"/>
                                        <field name="qty_diff" string="Difference"
                                               decoration-muted="qty_diff == 0" decoration-danger="qty_diff &lt; 0"
                                               decoration-success="qty_diff &gt; 0" decoration-bf="qty_diff != 0"/>
                                        <field name="standard_price" string="Prix unitaire (PMP)"/>
                                        <field name="valorisation" string="Valorisation"/>
                                        <button name="action_restore_line" type="object"
                                                string="Restaurer" icon="fa-undo"
                                                class="btn-primary"/>
                                    </list>
                                </field>

                            </page>

                            <page string="Lignes des Produits" invisible="1">
                                <field name="line_quant_ids" readonly="True">
                                    <list editable="bottom" create="1" edit="1">
                                        <field name="create_date" column_invisible="True"/>
                                        <field name="write_date" column_invisible="True"/>
                                        <field name="id" column_invisible="True"/>
                                        <field name="is_outdated" column_invisible="True"/>
                                        <field name="sn_duplicated" column_invisible="True"/>
                                        <field name="tracking" column_invisible="True"/>
                                        <field name="inventory_quantity_set" column_invisible="True"/>
                                        <field name="company_id" column_invisible="True"/>
                                        <field name="code_inventory_id" column_invisible="0"/>
                                        <field name="location_id" domain="[('usage', 'in', ['internal', 'transit'])]"
                                               column_invisible="context.get('hide_location', False)" readonly="id"
                                               options="{'no_create': True}"/>
                                        <field name="storage_category_id" groups="stock.group_stock_multi_locations"
                                               column_invisible="context.get('hide_location', False)"
                                               options="{'no_create': True}" optional="hidden"/>
                                        <field name="cyclic_inventory_frequency"
                                               column_invisible="context.get('hide_location', False)"
                                               options="{'no_create': True}" optional="hidden"/>
                                        <field name="is_favorite" widget="boolean_favorite" nolabel="1"
                                               optional="hidden"/>
                                        <field name="product_id" readonly="context.get('single_product', False) or id"
                                               force_save="1"
                                               options="{'no_create': True}"/>
                                        <field name="product_categ_id" optional="hide"/>
                                        <field name="lot_id" groups="stock.group_production_lot"
                                               column_invisible="context.get('hide_lot', False)"
                                               readonly="tracking not in ['serial', 'lot'] or (id and (lot_id or quantity != 0))"
                                               context="{'default_product_id': product_id}"
                                               decoration-danger="sn_duplicated" force_save="1"/>
                                        <field name="package_id" groups="stock.group_tracking_lot" readonly="id"/>
                                        <field name="owner_id" groups="stock.group_tracking_owner" readonly="id"
                                               options="{'no_create': True}"/>
                                        <field name="last_count_date" optional="hidden" readonly="1"/>
                                        <field name="quantity" optional="show" decoration-warning="quantity &lt; 0"
                                               string="Stock"/>
                                        <field name="product_uom_id" groups="uom.group_uom" string="UoM"/>
                                        <field name="inventory_date" optional="show"/>
                                        <field name="user_id" string="User" optional="show"/>
                                        <field name="company_id" groups="base.group_multi_company" optional="hide"/>
                                        <field name="lot_properties" optional="hide"/>
                                        <button name="action_inventory_history" type="object"
                                                class="btn btn-link text-info" icon="fa-history" string="Historique"/>
                                        <button name="action_apply_inventory" type="object" string="Appliquer"
                                                class="btn btn-link" icon="fa-save"
                                                invisible="not inventory_quantity_set"/>
                                        <button name="action_set_inventory_quantity" type="object" string="Copier"
                                                class="btn btn-link" icon="fa-bullseye"
                                                invisible="inventory_quantity_set"/>
                                        <button name="action_clear_inventory_quantity" type="object" string="Effacer"
                                                class="btn text-warning" icon="fa-times"
                                                invisible="not inventory_quantity_set"/>
                                    </list>
                                </field>
                            </page>

                            <page string="Description">
                                <field name="note" placeholder="Ajouter une note"/>
                            </page>

                        </notebook>
                    </sheet>
                    <chatter reload_on_follower="True"/>
                </form>
            </field>
        </record>

        <!-- Vue liste Code Inventaire -->
        <record id="view_physical_inventory_tree" model="ir.ui.view">
            <field name="name">physical.inventory.tree</field>
            <field name="model">physical.inventory</field>
            <field name="arch" type="xml">
                <list string="Code inventaire">
                    <field name="name"/>
                    <field name="code_inventory_id"/>
                    <field name="team_inventory_id"/>
                </list>
            </field>
        </record>

        <!-- Action Code Inventaire -->
        <record id="action_physical_inventory" model="ir.actions.act_window">
            <field name="name">Code Categorie inventaire</field>
            <field name="res_model">physical.inventory</field>
            <field name="view_mode">list,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créer votre premier Code Categorie inventaire
                </p>
            </field>
        </record>


        <!-- Menu principal -->

        <menuitem id="menu_action_physical_inventory"
                  name="Inventaire Physique Journalier"
                  parent="stock.menu_stock_adjustments"
                  action="action_physical_inventory"
                  sequence="2"/>

        <!-- Fermeture des menuitems -->
        <record id="make_invisible" model="res.groups">
            <field name="name">Invisible</field>
        </record>
        <record model="ir.ui.menu" id="stock.menu_action_inventory_tree">
            <field name="group_ids" eval="[(6,0,[ref('make_invisible')])]"/>
        </record>

    </data>

</odoo>