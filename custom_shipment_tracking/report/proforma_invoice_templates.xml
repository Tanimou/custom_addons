<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- ========================================== -->
    <!-- FACTURE PROFORMA REPORT - QWeb Template   -->
    <!-- For Sale Orders (Devis)                   -->
    <!-- Modèle basé sur FACTURE PRO AGILLY        -->
    <!-- ========================================== -->

    <!-- Minimal external layout for proforma - empty header, custom footer -->
    <template id="external_layout_proforma">
        <div class="header"/>
        <div class="article" t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id">
            <t t-out="0"/>
        </div>
        <!-- Custom footer with company info - wkhtmltopdf compatible -->
        <div class="footer" style="border-top: 3px solid #c00;">
            <table style="width: 100%; font-size: 7pt; color: #333; line-height: 1.5; font-family: Arial, sans-serif;">
                <tr>
                    <td style="padding: 5px 10px; text-align: center;">
                        <strong style="color: #c00;">GROUPE ICARE</strong><br/>
                        Abidjan – Plateau, Avenue Noguès, Im GRUBER, 2ème étage, porte 5<br/>
                        RCCM : CI-ABJ-2017-B-20097, CC 1735696V, Adresse, 12 BP 173 Abidjan 12, Tél :(+225) 27 20 32 51 22/ 27 20 24 43 34 / 01 03 86 40 40<br/>
                        Intitulé du compte : GROUPE ICARE, Banque : BICICI, / Devise : XOF Code Banque : IBAN : CI93 CI00 6015 5301 0387 2000 74<br/>
                        RIB 79, Code SWIFT (BIC) : BICICIABXXX | www.icare-voyages.com / reservation@icare-voyages.com
                    </td>
                </tr>
            </table>
        </div>
    </template>

    <!-- External Report Template -->
    <template id="report_sale_order_proforma_invoice">
        <t t-foreach="docs" t-as="order">
            <t t-set="o" t-value="order"/>
            <t t-set="company" t-value="order.company_id"/>
            <t t-call="custom_shipment_tracking.external_layout_proforma">
                <t t-call="custom_shipment_tracking.report_sale_order_proforma_invoice_document"/>
            </t>
        </t>
    </template>

    <!-- Single Proforma Invoice Document -->
    <template id="report_sale_order_proforma_invoice_document">
        <t t-set="company" t-value="order.company_id"/>
        <t t-set="partner" t-value="order.partner_id"/>
        
        <!-- Force UTF-8 encoding for wkhtmltopdf -->
        <meta charset="UTF-8"/>
        
        <!-- Main wrapper - required by Odoo 19 _prepare_html -->
        <main style="font-family: Arial, sans-serif; font-size: 10pt; color: #333;"
             t-att-data-oe-model="order and order._name"
             t-att-data-oe-id="order and order.id">
            
            <!-- ========================================== -->
            <!-- HEADER - Logo + Services + IATA           -->
            <!-- ========================================== -->
            <div style="display: table; width: 100%; margin-bottom: 10px;">
                <div style="display: table-cell; width: 30%; vertical-align: top;">
                    <!-- Logo entreprise (gauche) -->
                    <t t-if="company.logo">
                        <img t-att-src="'data:image/png;base64,' + company.logo.decode('utf-8')"
                             style="max-height: 60px; max-width: 180px;"
                             alt="Logo"/>
                    </t>
                    <t t-else="1">
                        <div style="font-size: 18pt; font-weight: bold; color: #c00;">
                            <t t-out="company.name"/>
                        </div>
                    </t>
                </div>
                <div style="display: table-cell; width: 50%; vertical-align: top; text-align: center; padding: 0 10px;">
                    <!-- Services description (centre) -->
                    <div style="font-size: 8pt; color: #333; line-height: 1.4;">
                        <strong>BILLETTERIE- HOTELS - ASSURANCES VOYAGES - ASSISTANCE VISA</strong><br/>
                        <strong>CIRCUITS TOURISTIQUES - EPARGNE VOYAGES - LOCATION DE VOITURE - LOCATION DE JET PRIVE</strong>
                    </div>
                </div>
                <div style="display: table-cell; width: 20%; vertical-align: top; text-align: right;">
                    <!-- Badge IATA / Accreditation (droite) -->
                    <t t-set="iata_badge" t-value="order._get_iata_badge_base64()"/>
                    <img t-if="iata_badge" t-att-src="image_data_uri(iata_badge)"
                         style="max-height: 70px; max-width: 140px;"
                         alt="IATA Accredited Agent"/>
                </div>
            </div>
            
            <!-- Red separator line -->
            <hr style="border: none; border-top: 2px solid black; margin: 5px 0 10px 0;"/>
            
            <!-- Tagline rouge - Dynamic from company or partner -->
            <div style="text-align: center; color: #c00; font-style: italic; font-size: 11pt; margin: 10px 0 20px 0;">
                <t t-if="company.report_header" t-out="company.report_header"/>
                <t t-else="1">Hello World, Sublime côte d'Ivoire</t>
            </div>
            
            <!-- ========================================== -->
            <!-- DATE (alignee a droite)                   -->
            <!-- ========================================== -->
            <div style="text-align: right; margin-bottom: 20px;">
                <t t-out="company.city or 'Abidjan'"/>, le <t t-out="order.date_order.strftime('%d %B %Y') if order.date_order else ''"/>
            </div>
            
            <!-- ========================================== -->
            <!-- TITRE + CLIENT BOX                        -->
            <!-- ========================================== -->
            <div style="display: table; width: 100%; margin-bottom: 15px;">
                <div style="display: table-cell; width: 50%; vertical-align: top;">
                    <!-- Titre FACTURE PROFORMA (gauche, souligne) -->
                    <div style="font-size: 14pt; font-weight: bold; text-decoration: underline; margin-bottom: 10px;">
                        FACTURE PROFORMA
                    </div>
                    <!-- Reference -->
                    <div style="margin-bottom: 5px;">
                        <span style="text-decoration: underline;">Ref.</span> : <t t-out="order.name"/>
                    </div>
                </div>
                <div style="display: table-cell; width: 50%; vertical-align: top; text-align: right;">
                    <!-- Boite CLIENT (droite, bordure) -->
                    <div style="display: inline-block; border: 2px solid #333; padding: 8px 15px; font-size: 12pt;">
                        <strong>CLIENT : </strong><t t-out="partner.name"/>
                    </div>
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- TABLEAU DE FACTURATION                    -->
            <!-- ========================================== -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <!-- En-tete du tableau -->
                <thead>
                    <tr style="background-color: #f5f5f5; border-top: 1px solid #333; border-bottom: 1px solid #333;">
                        <th style="padding: 8px; text-align: center; width: 5%; border-right: 1px solid #ccc;">No</th>
                        <th style="padding: 8px; text-align: left; width: 45%; border-right: 1px solid #ccc;">Designation</th>
                        <th style="padding: 8px; text-align: center; width: 18%; border-right: 1px solid #ccc;">Prix Unitaire</th>
                        <th style="padding: 8px; text-align: center; width: 8%; border-right: 1px solid #ccc;">Qte</th>
                        <th style="padding: 8px; text-align: right; width: 18%;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Order lines -->
                    <t t-set="line_number" t-value="1"/>
                    
                    <t t-foreach="order.order_line" t-as="line">
                        <t t-if="not line.display_type">
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px 8px; text-align: center; vertical-align: top; border-right: 1px solid #eee;">
                                    <t t-out="line_number"/>
                                </td>
                                <td style="padding: 10px 8px; vertical-align: top; border-right: 1px solid #eee;">
                                    <strong><t t-out="line.product_id.name"/></strong>
                                    <t t-if="line.name and line.name != line.product_id.name">
                                        <div style="font-size: 9pt; color: #666; margin-top: 4px;">
                                            <t t-out="line.name"/>
                                        </div>
                                    </t>
                                </td>
                                <td style="padding: 10px 8px; text-align: center; vertical-align: middle; border-right: 1px solid #eee;">
                                    <t t-out="'{:,.0f}'.format(line.price_unit)"/>
                                </td>
                                <td style="padding: 10px 8px; text-align: center; vertical-align: middle; border-right: 1px solid #eee;">
                                    <t t-out="'{:,.2f}'.format(line.product_uom_qty)"/>
                                </td>
                                <td style="padding: 10px 8px; text-align: right; vertical-align: middle;">
                                    <t t-out="'{:,.0f}'.format(line.price_subtotal)"/>
                                </td>
                            </tr>
                            <t t-set="line_number" t-value="line_number + 1"/>
                        </t>
                        <!-- Section line (display_type = 'line_section') -->
                        <t t-if="line.display_type == 'line_section'">
                            <tr style="background-color: #f0f0f0;">
                                <td colspan="5" style="padding: 8px; font-weight: bold;">
                                    <t t-out="line.name"/>
                                </td>
                            </tr>
                        </t>
                        <!-- Note line (display_type = 'line_note') -->
                        <t t-if="line.display_type == 'line_note'">
                            <tr>
                                <td colspan="5" style="padding: 8px; font-style: italic; color: #666;">
                                    <t t-out="line.name"/>
                                </td>
                            </tr>
                        </t>
                    </t>
                    
                    <!-- Subtotal HT
                    <tr style="border-top: 1px solid #333;">
                        <td colspan="4" style="padding: 10px 8px; text-align: right; font-weight: bold;">
                            Sous-total HT
                        </td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: bold;">
                            <t t-out="'{:,.0f}'.format(order.amount_untaxed)"/>
                        </td>
                    </tr>
                    
                    <t t-if="order.amount_tax > 0">
                        <tr>
                            <td colspan="4" style="padding: 10px 8px; text-align: right;">
                                Taxes
                            </td>
                            <td style="padding: 10px 8px; text-align: right;">
                                <t t-out="'{:,.0f}'.format(order.amount_tax)"/>
                            </td>
                        </tr>
                    </t> -->
                    
                    <!-- Ligne TOTAL -->
                    <tr style="background-color: #e8e8e8; border-top: 2px solid #333;">
                        <td colspan="4" style="padding: 10px 8px; text-align: center; font-weight: bold; font-size: 12pt;">
                            TOTAL TTC
                        </td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: bold; font-size: 12pt;">
                            <t t-out="'{:,.0f}'.format(order.amount_total)"/> <t t-out="order.currency_id.symbol"/>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- ========================================== -->
            <!-- SECTION MONTANT EN LETTRES                -->
            <!-- ========================================== -->
            <div style="margin-bottom: 20px;">
                <div style="text-decoration: underline; font-weight: bold; margin-bottom: 5px;">
                    ARRETE LE PRESENT DEVIS PROFORMA A LA SOMME DE :
                </div>
                <div style="font-weight: bold; font-size: 10pt;">
                    (<t t-out="order._amount_to_text(order.amount_total)"/>)
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- SECTION PAIEMENT                          -->
            <!-- ========================================== -->
            <div style="margin-bottom: 15px;">
                <div>
                    Tout paiement par cheque doit etre libelle a l'ordre de "<t t-out="company.name"/>"
                </div>
                <div>Reference Bancaire :</div>
            </div>
            
            <!-- Boite des coordonnees bancaires -->
            <div style="border: 1px solid #333; padding: 10px; margin-bottom: 30px; font-size: 9pt; max-width: 400px;">
                <t t-if="company.partner_id.bank_ids">
                    <t t-set="bank" t-value="company.partner_id.bank_ids[0]"/>
                    <div><strong>Intitule du compte :</strong> <t t-out="company.name"/>,</div>
                    <div><strong>Banque :</strong> <t t-out="bank.bank_id.name if bank.bank_id else '-'"/>,</div>
                    <div><strong>IBAN :</strong> <t t-out="bank.acc_number or '-'"/>,</div>
                </t>
                <t t-else="1">
                    <div><strong>Intitule du compte :</strong> <t t-out="company.name"/>,</div>
                    <div><strong>Banque :</strong> -,</div>
                    <div><strong>IBAN :</strong> -,</div>
                </t>
            </div>
            
            <!-- ========================================== -->
            <!-- SECTION SIGNATURE                         -->
            <!-- ========================================== -->
            <div style="text-align: right; margin-bottom: 40px;">
                <div style="font-weight: bold; font-size: 11pt; color: #c00; margin-bottom: 60px;">
                    La Comptabilite
                </div>
                <!-- Espace pour signature et cachet -->
                <div style="height: 80px;">
                    <!-- Signature space -->
                </div>
            </div>
            
        </main>
        
        <!-- ========================================== -->
        <!-- FOOTER - Sticky footer using wkhtmltopdf  -->
        <!-- native footer class (repeats on each page)-->
        <!-- ========================================== -->
        <!-- <t t-set="footer_image" t-value="order._get_footer_image_base64()"/>
        <div class="footer" style="padding: 0; margin: 0;">
            <div t-if="footer_image" style="width: 100%; text-align: center;">
                <img t-att-src="image_data_uri(footer_image)"
                     style="width: 100%; height: auto; display: block;"
                     alt="Footer"/>
            </div>
        </div> -->
            
    </template>

</odoo>
