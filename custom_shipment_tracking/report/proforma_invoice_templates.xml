<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- ========================================== -->
    <!-- FACTURE PROFORMA REPORT - QWeb Template   -->
    <!-- For Sale Orders (Devis)                   -->
    <!-- Modèle basé sur FACTURE PRO AGILLY        -->
    <!-- ========================================== -->

    <!-- External Report Template -->
    <template id="report_sale_order_proforma_invoice">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="order">
                <t t-call="custom_shipment_tracking.report_sale_order_proforma_invoice_document"/>
            </t>
        </t>
    </template>

    <!-- Single Proforma Invoice Document -->
    <template id="report_sale_order_proforma_invoice_document">
        <t t-set="company" t-value="order.company_id"/>
        <t t-set="partner" t-value="order.partner_id"/>
        
        <!-- Force UTF-8 encoding for wkhtmltopdf -->
        <meta charset="UTF-8"/>
        
        <div class="page" style="font-family: Arial, sans-serif; font-size: 10pt; color: #333;">
            
            <!-- ========================================== -->
            <!-- HEADER - Logo + Services + IATA           -->
            <!-- ========================================== -->
            <div style="display: table; width: 100%; margin-bottom: 10px;">
                <div style="display: table-cell; width: 30%; vertical-align: top;">
                    <!-- Logo entreprise (gauche) -->
                    <t t-if="company.logo">
                        <img t-att-src="'data:image/png;base64,' + company.logo.decode('utf-8')"
                             style="max-height: 60px; max-width: 180px;"
                             alt="Logo"/>
                    </t>
                    <t t-else="1">
                        <div style="font-size: 18pt; font-weight: bold; color: #c00;">
                            <t t-out="company.name"/>
                        </div>
                    </t>
                </div>
                <div style="display: table-cell; width: 50%; vertical-align: top; text-align: center; padding: 0 10px;">
                    <!-- Services description (centre) -->
                    <div style="font-size: 8pt; color: #333; line-height: 1.4;">
                        <strong>BILLETTERIE- HOTELS - ASSURANCES VOYAGES - ASSISTANCE VISA</strong><br/>
                        <strong>CIRCUITS TOURISTIQUES - EPARGNE VOYAGES - LOCATION DE VOITURE</strong>
                    </div>
                </div>
                <div style="display: table-cell; width: 20%; vertical-align: top; text-align: right;">
                    <!-- Badge IATA / Accreditation (droite) -->
                    <div style="font-size: 8pt; color: #666;">
                        Accredite<br/>Agent
                    </div>
                </div>
            </div>
            
            <!-- Tagline rouge - Dynamic from company or partner -->
            <div style="text-align: center; color: #c00; font-style: italic; font-size: 11pt; margin: 10px 0 20px 0;">
                <t t-if="company.report_header" t-out="company.report_header"/>
                <t t-else="1">Hello World, Sublime côte d'Ivoire</t>
            </div>
            
            <!-- ========================================== -->
            <!-- DATE (alignee a droite)                   -->
            <!-- ========================================== -->
            <div style="text-align: right; margin-bottom: 20px;">
                <t t-out="company.city or 'Abidjan'"/>, le <t t-out="order.date_order.strftime('%d %B %Y') if order.date_order else ''"/>
            </div>
            
            <!-- ========================================== -->
            <!-- TITRE + CLIENT BOX                        -->
            <!-- ========================================== -->
            <div style="display: table; width: 100%; margin-bottom: 15px;">
                <div style="display: table-cell; width: 50%; vertical-align: top;">
                    <!-- Titre FACTURE PROFORMA (gauche, souligne) -->
                    <div style="font-size: 14pt; font-weight: bold; text-decoration: underline; margin-bottom: 10px;">
                        FACTURE PROFORMA
                    </div>
                    <!-- Reference -->
                    <div style="margin-bottom: 5px;">
                        <span style="text-decoration: underline;">Ref.</span> : <t t-out="order.name"/>
                    </div>
                </div>
                <div style="display: table-cell; width: 50%; vertical-align: top; text-align: right;">
                    <!-- Boite CLIENT (droite, bordure) -->
                    <div style="display: inline-block; border: 2px solid #333; padding: 8px 15px; font-size: 12pt;">
                        <strong>CLIENT : </strong><t t-out="partner.name"/>
                    </div>
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- TABLEAU DE FACTURATION                    -->
            <!-- ========================================== -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <!-- En-tete du tableau -->
                <thead>
                    <tr style="background-color: #f5f5f5; border-top: 1px solid #333; border-bottom: 1px solid #333;">
                        <th style="padding: 8px; text-align: center; width: 5%; border-right: 1px solid #ccc;">No</th>
                        <th style="padding: 8px; text-align: left; width: 45%; border-right: 1px solid #ccc;">Designation</th>
                        <th style="padding: 8px; text-align: center; width: 18%; border-right: 1px solid #ccc;">Prix Unitaire</th>
                        <th style="padding: 8px; text-align: center; width: 8%; border-right: 1px solid #ccc;">Qte</th>
                        <th style="padding: 8px; text-align: right; width: 18%;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Order lines -->
                    <t t-set="line_number" t-value="1"/>
                    
                    <t t-foreach="order.order_line" t-as="line">
                        <t t-if="not line.display_type">
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px 8px; text-align: center; vertical-align: top; border-right: 1px solid #eee;">
                                    <t t-out="line_number"/>
                                </td>
                                <td style="padding: 10px 8px; vertical-align: top; border-right: 1px solid #eee;">
                                    <strong><t t-out="line.product_id.name"/></strong>
                                    <t t-if="line.name and line.name != line.product_id.name">
                                        <div style="font-size: 9pt; color: #666; margin-top: 4px;">
                                            <t t-out="line.name"/>
                                        </div>
                                    </t>
                                </td>
                                <td style="padding: 10px 8px; text-align: center; vertical-align: middle; border-right: 1px solid #eee;">
                                    <t t-out="'{:,.0f}'.format(line.price_unit)"/>
                                </td>
                                <td style="padding: 10px 8px; text-align: center; vertical-align: middle; border-right: 1px solid #eee;">
                                    <t t-out="'{:,.2f}'.format(line.product_uom_qty)"/>
                                </td>
                                <td style="padding: 10px 8px; text-align: right; vertical-align: middle;">
                                    <t t-out="'{:,.0f}'.format(line.price_subtotal)"/>
                                </td>
                            </tr>
                            <t t-set="line_number" t-value="line_number + 1"/>
                        </t>
                        <!-- Section line (display_type = 'line_section') -->
                        <t t-if="line.display_type == 'line_section'">
                            <tr style="background-color: #f0f0f0;">
                                <td colspan="5" style="padding: 8px; font-weight: bold;">
                                    <t t-out="line.name"/>
                                </td>
                            </tr>
                        </t>
                        <!-- Note line (display_type = 'line_note') -->
                        <t t-if="line.display_type == 'line_note'">
                            <tr>
                                <td colspan="5" style="padding: 8px; font-style: italic; color: #666;">
                                    <t t-out="line.name"/>
                                </td>
                            </tr>
                        </t>
                    </t>
                    
                    <!-- Subtotal HT
                    <tr style="border-top: 1px solid #333;">
                        <td colspan="4" style="padding: 10px 8px; text-align: right; font-weight: bold;">
                            Sous-total HT
                        </td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: bold;">
                            <t t-out="'{:,.0f}'.format(order.amount_untaxed)"/>
                        </td>
                    </tr>
                    
                    <t t-if="order.amount_tax > 0">
                        <tr>
                            <td colspan="4" style="padding: 10px 8px; text-align: right;">
                                Taxes
                            </td>
                            <td style="padding: 10px 8px; text-align: right;">
                                <t t-out="'{:,.0f}'.format(order.amount_tax)"/>
                            </td>
                        </tr>
                    </t> -->
                    
                    <!-- Ligne TOTAL -->
                    <tr style="background-color: #e8e8e8; border-top: 2px solid #333;">
                        <td colspan="4" style="padding: 10px 8px; text-align: center; font-weight: bold; font-size: 12pt;">
                            TOTAL TTC
                        </td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: bold; font-size: 12pt;">
                            <t t-out="'{:,.0f}'.format(order.amount_total)"/> <t t-out="order.currency_id.symbol"/>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- ========================================== -->
            <!-- SECTION MONTANT EN LETTRES                -->
            <!-- ========================================== -->
            <div style="margin-bottom: 20px;">
                <div style="text-decoration: underline; font-weight: bold; margin-bottom: 5px;">
                    ARRETE LE PRESENT DEVIS PROFORMA A LA SOMME DE :
                </div>
                <div style="font-weight: bold; font-size: 10pt;">
                    (<t t-out="order._amount_to_text(order.amount_total)"/>)
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- SECTION PAIEMENT                          -->
            <!-- ========================================== -->
            <div style="margin-bottom: 15px;">
                <div>
                    Tout paiement par cheque doit etre libelle a l'ordre de "<t t-out="company.name"/>"
                </div>
                <div>Reference Bancaire :</div>
            </div>
            
            <!-- Boite des coordonnees bancaires -->
            <div style="border: 1px solid #333; padding: 10px; margin-bottom: 30px; font-size: 9pt; max-width: 400px;">
                <t t-if="company.partner_id.bank_ids">
                    <t t-set="bank" t-value="company.partner_id.bank_ids[0]"/>
                    <div><strong>Intitule du compte :</strong> <t t-out="company.name"/>,</div>
                    <div><strong>Banque :</strong> <t t-out="bank.bank_id.name if bank.bank_id else '-'"/>,</div>
                    <div><strong>IBAN :</strong> <t t-out="bank.acc_number or '-'"/>,</div>
                </t>
                <t t-else="1">
                    <div><strong>Intitule du compte :</strong> <t t-out="company.name"/>,</div>
                    <div><strong>Banque :</strong> -,</div>
                    <div><strong>IBAN :</strong> -,</div>
                </t>
            </div>
            
            <!-- ========================================== -->
            <!-- SECTION SIGNATURE                         -->
            <!-- ========================================== -->
            <div style="text-align: right; margin-bottom: 40px;">
                <div style="font-weight: bold; font-size: 11pt; color: #c00; margin-bottom: 60px;">
                    La Comptabilite
                </div>
                <!-- Espace pour signature et cachet -->
                <div style="height: 80px;">
                    <!-- Signature space -->
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- FOOTER - Informations entreprise          -->
            <!-- ========================================== -->
            <div style="border-top: 3px solid #c00; padding-top: 10px; font-size: 8pt; color: #666; text-align: center; margin-top: 30px;">
                <div style="margin-bottom: 5px;">
                    <strong style="color: #c00;"><t t-out="company.name"/></strong>
                </div>
                <div>
                    <t t-if="company.street"><t t-out="company.street"/>, </t>
                    <t t-if="company.street2"><t t-out="company.street2"/>, </t>
                    <t t-if="company.city"><t t-out="company.city"/> </t>
                    <t t-if="company.zip"><t t-out="company.zip"/></t>
                </div>
                <div>
                    <t t-if="company.country_id"><t t-out="company.country_id.name"/></t>
                </div>
                <div style="margin-top: 5px;">
                    <t t-if="company.phone">Tel : <t t-out="company.phone"/> | </t>
                    <t t-if="company.email"><t t-out="company.email"/></t>
                    <t t-if="company.website"> | <t t-out="company.website"/></t>
                </div>
                <t t-if="company.partner_id.bank_ids">
                    <t t-set="bank" t-value="company.partner_id.bank_ids[0]"/>
                    <div style="margin-top: 5px;">
                        Intitule du compte : <t t-out="company.name"/>, Banque : <t t-out="bank.bank_id.name if bank.bank_id else '-'"/>,
                        / Devise : <t t-out="company.currency_id.name or 'XOF'"/> /
                        IBAN : <t t-out="bank.acc_number or '-'"/>
                    </div>
                </t>
            </div>
            
        </div>
    </template>

</odoo>
