<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- ========================================== -->
    <!-- FACTURE PROFORMA REPORT - MYRED TRAVELS   -->
    <!-- For Sale Orders (Devis)                   -->
    <!-- Modèle basé sur MYRED TRAVELS branding    -->
    <!-- ========================================== -->

    <!-- Minimal external layout for MYRED proforma - empty header, custom footer -->
    <template id="external_layout_proforma_myred">
        <div class="header"/>
        <div class="article" t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id">
            <t t-out="0"/>
        </div>
        <!-- Custom footer with MYRED TRAVELS company info - wkhtmltopdf compatible -->
        <div class="footer" style="border-top: 3px solid #c00;">
            <table style="width: 100%; font-size: 7pt; color: #333; line-height: 1.4; font-family: Arial, sans-serif;">
                <tr>
                    <!-- Logo colibri à gauche -->
                    <!-- <td style="width: 60px; vertical-align: middle; padding: 5px;">
                        <img src="/custom_shipment_tracking/static/myredtravel_logo.png"
                             style="max-height: 45px; max-width: 50px;"
                             alt="MyRed Travels"/>
                    </td> -->
                    <!-- Contenu du pied de page -->
                    <td style="padding: 5px 10px; color: #c00">
                        <div style="text-align: right; font-style: italic; font-weight: bold; margin-bottom: 3px;">
                            Agence de voyages 100% Digitale
                        </div>
                        <div style="text-align: center; color: #c00;">
                            Agence de voyages du Groupe Icare / Siège social : Abidjan - Plateau Av Nogues Im. Gruber 2e étage porte 6<br/>
                            RCCM : CI-ABJ-2017-B-20097 - N° CC 17 35 696 / 01 BP 6949 Abidjan 01<br/>
                            (+225) 27 20 27 47 12 / 05 56 16 28 28 / 01 03 86 39 39 / +336 65 970 969<br/>
                            E-mail: contact@myredtravels.com / Site web: www.myredtravels.com
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </template>

    <!-- External Report Template for MYRED TRAVELS -->
    <template id="report_sale_order_proforma_myred">
        <t t-foreach="docs" t-as="order">
            <t t-set="o" t-value="order"/>
            <t t-set="company" t-value="order.company_id"/>
            <t t-call="custom_shipment_tracking.external_layout_proforma_myred">
                <t t-call="custom_shipment_tracking.report_sale_order_proforma_myred_document"/>
            </t>
        </t>
    </template>

    <!-- Single Proforma Invoice Document for MYRED TRAVELS -->
    <template id="report_sale_order_proforma_myred_document">
        <t t-set="company" t-value="order.company_id"/>
        <t t-set="partner" t-value="order.partner_id"/>
        
        <!-- Force UTF-8 encoding for wkhtmltopdf -->
        <meta charset="UTF-8"/>
        
        <!-- Main wrapper - required by Odoo 19 _prepare_html -->
        <main style="font-family: Arial, sans-serif; font-size: 10pt; color: #333;"
             t-att-data-oe-model="order and order._name"
             t-att-data-oe-id="order and order.id">
            
            <!-- ========================================== -->
            <!-- HEADER - Logo MYRED + Services + IATA     -->
            <!-- ========================================== -->
            <div style="display: table; width: 100%; margin-bottom: 10px;">
                <div style="display: table-cell; width: 30%; vertical-align: top;">
                    <!-- Logo MYRED TRAVELS (gauche) - hardcoded -->
                    <t t-if="company.logo">
                        <img t-att-src="'data:image/png;base64,' + company.logo.decode('utf-8')"
                             style="max-height: 60px; max-width: 180px;"
                             alt="Logo"/>
                    </t>
                    <t t-else="1">
                        <div style="font-size: 18pt; font-weight: bold; color: #c00;">
                            <t t-out="company.name"/>
                        </div>
                    </t>
                </div>
                <div style="display: table-cell; width: 50%; vertical-align: top; text-align: center; padding: 0 10px;">
                    <!-- Services description (centre) -->
                    <!-- <div style="font-size: 8pt; color: #333; line-height: 1.4;">
                        <strong>BILLETTERIE- HOTELS - ASSURANCES VOYAGES - ASSISTANCE VISA</strong><br/>
                        <strong>CIRCUITS TOURISTIQUES - EPARGNE VOYAGES - LOCATION DE VOITURE - LOCATION DE JET PRIVE</strong>
                    </div> -->
                </div>
                <!-- <div style="display: table-cell; width: 20%; vertical-align: top; text-align: right;">
                    <t t-set="iata_badge" t-value="order._get_iata_badge_base64()"/>
                    <img t-if="iata_badge" t-att-src="image_data_uri(iata_badge)"
                         style="max-height: 70px; max-width: 140px;"
                         alt="IATA Accredited Agent"/>
                </div> -->
            </div>
            
            <!-- Red separator line -->
            <hr style="border: none; border-top: 2px solid black; color : #c00;margin: 5px 0 10px 0;"/>
            
            <!-- Tagline rouge - Dynamic from company or default -->
            <!-- <div style="text-align: center; color: #c00; font-style: italic; font-size: 11pt; margin: 10px 0 20px 0;">
                <t t-if="company.report_header" t-out="company.report_header"/>
                <t t-else="1">Agence de voyages 100% Digitale</t>
            </div> -->
            
            <!-- ========================================== -->
            <!-- DATE (alignee a droite)                   -->
            <!-- ========================================== -->
            <div style="text-align: right; margin-bottom: 20px;">
                <t t-out="company.city or 'Abidjan'"/>, le <t t-out="order.date_order.strftime('%d %B %Y') if order.date_order else ''"/>
            </div>
            
            <!-- ========================================== -->
            <!-- TITRE + CLIENT BOX                        -->
            <!-- ========================================== -->
            <div style="display: table; width: 100%; margin-bottom: 15px;">
                <div style="display: table-cell; width: 50%; vertical-align: top;">
                    <!-- Titre FACTURE PROFORMA (gauche, souligne) -->
                    <div style="font-size: 14pt; font-weight: bold; text-decoration: underline; margin-bottom: 10px;">
                        FACTURE PROFORMA
                    </div>
                    <!-- Reference -->
                    <div style="margin-bottom: 5px;">
                        <span style="text-decoration: underline;">Ref.</span> : <t t-out="order.name"/>
                    </div>
                </div>
                <div style="display: table-cell; width: 50%; vertical-align: top; text-align: right;">
                    <!-- Boite CLIENT (droite, bordure) -->
                    <div style="display: inline-block; border: 2px solid #333; padding: 8px 15px; font-size: 12pt;">
                        <strong>CLIENT : </strong><t t-out="partner.name"/>
                    </div>
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- TABLEAU DE FACTURATION                    -->
            <!-- ========================================== -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <!-- En-tete du tableau -->
                <thead>
                    <tr style="background-color: #f5f5f5; border-top: 1px solid #333; border-bottom: 1px solid #333;">
                        <th style="padding: 8px; text-align: center; width: 5%; border-right: 1px solid #ccc;">No</th>
                        <th style="padding: 8px; text-align: left; width: 45%; border-right: 1px solid #ccc;">Designation</th>
                        <th style="padding: 8px; text-align: center; width: 18%; border-right: 1px solid #ccc;">Prix Unitaire</th>
                        <th style="padding: 8px; text-align: center; width: 8%; border-right: 1px solid #ccc;">Qte</th>
                        <th style="padding: 8px; text-align: right; width: 18%;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Order lines -->
                    <t t-set="line_number" t-value="1"/>
                    
                    <t t-foreach="order.order_line" t-as="line">
                        <t t-if="not line.display_type">
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px 8px; text-align: center; vertical-align: top; border-right: 1px solid #eee;">
                                    <t t-out="line_number"/>
                                </td>
                                <td style="padding: 10px 8px; vertical-align: top; border-right: 1px solid #eee;">
                                    <strong><t t-out="line.product_id.name"/></strong>
                                    <t t-if="line.name and line.name != line.product_id.name">
                                        <div style="font-size: 9pt; color: #666; margin-top: 4px; white-space: pre-line;">
                                            <t t-out="line.name"/>
                                        </div>
                                    </t>
                                </td>
                                <td style="padding: 10px 8px; text-align: center; vertical-align: middle; border-right: 1px solid #eee;">
                                    <t t-out="'{:,.0f}'.format(line.price_unit)"/>
                                </td>
                                <td style="padding: 10px 8px; text-align: center; vertical-align: middle; border-right: 1px solid #eee;">
                                    <t t-out="'{:,.2f}'.format(line.product_uom_qty)"/>
                                </td>
                                <td style="padding: 10px 8px; text-align: right; vertical-align: middle;">
                                    <t t-out="'{:,.0f}'.format(line.price_subtotal)"/>
                                </td>
                            </tr>
                            <t t-set="line_number" t-value="line_number + 1"/>
                        </t>
                        <!-- Section line (display_type = 'line_section') -->
                        <t t-if="line.display_type == 'line_section'">
                            <tr style="background-color: #f0f0f0;">
                                <td colspan="5" style="padding: 8px; font-weight: bold;">
                                    <t t-out="line.name"/>
                                </td>
                            </tr>
                        </t>
                        <!-- Note line (display_type = 'line_note') -->
                        <t t-if="line.display_type == 'line_note'">
                            <tr>
                                <td colspan="5" style="padding: 8px; font-style: italic; color: #666; white-space: pre-line;">
                                    <t t-out="line.name"/>
                                </td>
                            </tr>
                        </t>
                    </t>
                    
                    <!-- Ligne TOTAL -->
                    <tr style="background-color: #e8e8e8; border-top: 2px solid #333;">
                        <td colspan="4" style="padding: 10px 8px; text-align: center; font-weight: bold; font-size: 12pt;">
                            TOTAL TTC
                        </td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: bold; font-size: 12pt;">
                            <t t-out="'{:,.0f}'.format(order.amount_total)"/> <t t-out="order.currency_id.symbol"/>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- ========================================== -->
            <!-- SECTION MONTANT EN LETTRES                -->
            <!-- ========================================== -->
            <div style="margin-bottom: 20px;">
                <div style="text-decoration: underline; font-weight: bold; margin-bottom: 5px;">
                    ARRETE LE PRESENT DEVIS PROFORMA A LA SOMME DE :
                </div>
                <div style="font-weight: bold; font-size: 10pt;">
                    (<t t-out="order._amount_to_text(order.amount_total)"/>)
                </div>
            </div>
            
            <!-- ========================================== -->
            <!-- SECTION PAIEMENT                          -->
            <!-- ========================================== -->
            <div style="margin-bottom: 15px;">
                <div>
                    Tout paiement par cheque doit etre libelle a l'ordre de "<t t-out="company.name"/>"
                </div>
                <div>Reference Bancaire :</div>
            </div>
            
            <!-- Boite des coordonnees bancaires -->
            <div style="border: 1px solid #333; padding: 10px; margin-bottom: 30px; font-size: 9pt; max-width: 400px;">
                <t t-if="company.partner_id.bank_ids">
                    <t t-set="bank" t-value="company.partner_id.bank_ids[0]"/>
                    <div><strong>Intitule du compte :</strong> <t t-out="company.name"/>,</div>
                    <div><strong>Banque :</strong> <t t-out="bank.bank_id.name if bank.bank_id else '-'"/>,</div>
                    <div><strong>IBAN :</strong> <t t-out="bank.acc_number or '-'"/>,</div>
                </t>
                <t t-else="1">
                    <div><strong>Intitule du compte :</strong> <t t-out="company.name"/>,</div>
                    <div><strong>Banque :</strong> -,</div>
                    <div><strong>IBAN :</strong> -,</div>
                </t>
            </div>
            
            <!-- ========================================== -->
            <!-- SECTION SIGNATURE - MYRED TRAVELS CACHET  -->
            <!-- ========================================== -->
            <div style="text-align: right; margin-bottom: 40px;">
                <div style="font-weight: bold; font-size: 11pt; color: #c00; margin-bottom: 10px;">
                    La Comptabilite
                </div>
                <!-- Espace pour signature et cachet MYRED TRAVELS -->
                <div style="display: inline-block; text-align: center;">
                    <t t-set="cachet_image" t-value="order._get_cachet_myred_image_base64()"/>
                    <div t-if="cachet_image" style="margin-top: 10px;">
                        <img t-att-src="image_data_uri(cachet_image)"
                             style="max-width: 180px; max-height: 130px; height: auto;"
                             alt="Cachet"/>
                    </div>
                    <div t-else="1" style="height: 80px;">
                        <!-- Space for manual signature/stamp -->
                    </div>
                </div>            
            </div>
            
        </main>
            
    </template>

</odoo>
