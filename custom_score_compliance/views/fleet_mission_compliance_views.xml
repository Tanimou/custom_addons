<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ===================================================================
         Mission Compliance Views Extension (FR-007a)
         Display compliance status and blocking reasons on mission form
         =================================================================== -->

    <!-- ===================================================================
         EXTEND MISSION FORM: Add compliance status display
         =================================================================== -->
    <record id="fleet_mission_form_view_compliance" model="ir.ui.view">
        <field name="name">fleet.mission.form.compliance</field>
        <field name="model">fleet.mission</field>
        <field name="inherit_id" ref="custom_fleet_management.fleet_mission_view_form"/>
        <field name="arch" type="xml">
            <!-- Add compliance info after vehicle selection -->
            <xpath expr="//field[@name='vehicle_id']" position="after">
                <field name="compliance_status" widget="badge"
                       decoration-success="compliance_status == 'ok'"
                       decoration-warning="compliance_status == 'warning'"
                       decoration-danger="compliance_status == 'blocked'"
                       invisible="not vehicle_id"
                       readonly="1"/>
            </xpath>
            
            <!-- Add compliance warning/blocking alert before buttons -->
            <xpath expr="//sheet" position="inside">
                <div class="alert alert-danger mt-3" role="alert"
                     invisible="compliance_status != 'blocked'">
                    <strong><i class="fa fa-exclamation-triangle"/> Documents Critiques Expirés</strong>
                    <field name="compliance_blocking_reason" nolabel="1"/>
                </div>
                <div class="alert alert-warning mt-3" role="alert"
                     invisible="not has_compliance_warning">
                    <strong><i class="fa fa-exclamation-circle"/> Attention</strong>
                    <field name="compliance_warning_message" nolabel="1"/>
                </div>
            </xpath>
        </field>
    </record>

    <!-- ===================================================================
         EXTEND MISSION TREE: Add compliance status column
         =================================================================== -->
    <record id="fleet_mission_tree_view_compliance" model="ir.ui.view">
        <field name="name">fleet.mission.list.compliance</field>
        <field name="model">fleet.mission</field>
        <field name="inherit_id" ref="custom_fleet_management.fleet_mission_view_list"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="before">
                <field name="compliance_status" widget="badge"
                       decoration-success="compliance_status == 'ok'"
                       decoration-warning="compliance_status == 'warning'"
                       decoration-danger="compliance_status == 'blocked'"
                       optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- ===================================================================
         EXTEND MISSION KANBAN: Add compliance indicator
         =================================================================== -->
    <record id="fleet_mission_kanban_view_compliance" model="ir.ui.view">
        <field name="name">fleet.mission.kanban.compliance</field>
        <field name="model">fleet.mission</field>
        <field name="inherit_id" ref="custom_fleet_management.fleet_mission_view_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//templates" position="before">
                <field name="compliance_status"/>
            </xpath>
        </field>
    </record>

    <!-- ===================================================================
         EXTEND MISSION SEARCH: Add compliance filters
         Note: The base search view in custom_fleet_management is currently 
         commented out. Creating a standalone search view instead.
         =================================================================== -->
    <record id="fleet_mission_search_view_compliance" model="ir.ui.view">
        <field name="name">fleet.mission.search.compliance</field>
        <field name="model">fleet.mission</field>
        <field name="arch" type="xml">
            <search string="Rechercher Missions">
                <field name="name" string="Référence" filter_domain="['|', ('name','ilike',self), ('order_number','ilike',self)]"/>
                <field name="vehicle_id"/>
                <field name="driver_id"/>
                <field name="requester_id"/>
                <field name="mission_type"/>
                <separator/>
                <filter string="Mes Missions (Demandeur)" name="my_missions_requester" domain="[('requester_id.user_id','=',uid)]"/>
                <filter string="Mes Missions (Conducteur)" name="my_missions_driver" domain="[('driver_id.user_id','=',uid)]"/>
                <separator/>
                <filter string="Brouillon" name="draft" domain="[('state','=','draft')]"/>
                <filter string="En Attente" name="submitted" domain="[('state','=','submitted')]"/>
                <filter string="Approuvées" name="approved" domain="[('state','=','approved')]"/>
                <filter string="En Cours" name="in_progress" domain="[('state','=','in_progress')]"/>
                <filter string="Terminées" name="done" domain="[('state','=','done')]"/>
                <separator/>
                <filter name="compliance_blocked" string="Conformité Bloquée" 
                        domain="[('compliance_status', '=', 'blocked')]"/>
                <filter name="compliance_warning" string="Avertissement Conformité" 
                        domain="[('compliance_status', '=', 'warning')]"/>
                <filter name="compliance_ok" string="Conformité OK" 
                        domain="[('compliance_status', '=', 'ok')]"/>
                <separator/>
                <!-- has_conflict is a non-stored computed field, cannot be filtered in domain -->
                <!-- <group expand="0" string="Regrouper par">
                    <filter string="Conducteur" name="group_driver" context="{'group_by':'driver_id'}"/>
                    <filter string="Véhicule" name="group_vehicle" context="{'group_by':'vehicle_id'}"/>
                    <filter string="Type" name="group_type" context="{'group_by':'mission_type'}"/>
                    <filter string="État" name="group_state" context="{'group_by':'state'}"/>
                    <filter string="Conformité" name="group_compliance" context="{'group_by':'compliance_status'}"/>
                    <filter string="Mois Départ" name="group_month" context="{'group_by':'date_start:month'}"/>
                </group> -->
            </search>
        </field>
    </record>

    <!-- ===================================================================
         EXTEND VEHICLE FORM: Add document compliance section
         =================================================================== -->
    <record id="fleet_vehicle_form_view_compliance" model="ir.ui.view">
        <field name="name">fleet.vehicle.form.compliance</field>
        <field name="model">fleet.vehicle</field>
        <field name="inherit_id" ref="fleet.fleet_vehicle_view_form"/>
        <field name="arch" type="xml">
            <!-- Add compliance status badge near vehicle info -->
            <xpath expr="//div[hasclass('oe_title')]" position="after">
                <div class="alert alert-danger mb-3" role="alert" 
                     invisible="not has_expired_critical_docs">
                    <strong><i class="fa fa-exclamation-triangle"/> Documents Critiques Expirés</strong><br/>
                    <span><field name="expired_critical_doc_count"/> document(s) critique(s) expiré(s).
                    Ce véhicule ne peut pas être utilisé pour des missions.</span>
                </div>
                <div class="alert alert-warning mb-3" role="alert" 
                     invisible="has_expired_critical_docs or not has_expiring_soon_docs">
                    <strong><i class="fa fa-clock-o"/> Documents à Renouveler</strong><br/>
                    <span><field name="expiring_soon_doc_count"/> document(s) expire(nt) dans les 30 prochains jours.</span>
                </div>
            </xpath>
        </field>
    </record>

    <!-- ===================================================================
         EXTEND VEHICLE TREE: Add compliance indicator
         =================================================================== -->
    <record id="fleet_vehicle_tree_view_compliance" model="ir.ui.view">
        <field name="name">fleet.vehicle.tree.compliance</field>
        <field name="model">fleet.vehicle</field>
        <field name="inherit_id" ref="fleet.fleet_vehicle_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//list" position="inside">
                <field name="compliance_status" widget="badge"
                       decoration-success="compliance_status == 'ok'"
                       decoration-warning="compliance_status == 'warning'"
                       decoration-danger="compliance_status == 'blocked'"
                       optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- ===================================================================
         EXTEND DOCUMENT FORM: Add document type Many2one
         =================================================================== -->
    <record id="fleet_vehicle_document_form_view_type" model="ir.ui.view">
        <field name="name">fleet.vehicle.document.form.type</field>
        <field name="model">fleet.vehicle.document</field>
        <field name="inherit_id" ref="custom_fleet_management.fleet_vehicle_document_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='document_type']" position="after">
                <field name="document_type_id" 
                       options="{'no_create': True}"
                       placeholder="Sélectionner un type de document..."/>
                <field name="is_critical_document" invisible="1"/>
            </xpath>
            <!-- Add visual indicator for critical documents -->
            <xpath expr="//sheet" position="inside">
                <div class="alert alert-info mt-3" role="alert"
                     invisible="not is_critical_document">
                    <strong><i class="fa fa-shield"/> Document Critique</strong><br/>
                    L'expiration de ce document bloquera les missions du véhicule.
                </div>
            </xpath>
        </field>
    </record>

    <!-- ===================================================================
         EXTEND DOCUMENT TREE: Add document type and critical flag
         =================================================================== -->
    <record id="fleet_vehicle_document_tree_view_type" model="ir.ui.view">
        <field name="name">fleet.vehicle.document.list.type</field>
        <field name="model">fleet.vehicle.document</field>
        <field name="inherit_id" ref="custom_fleet_management.fleet_vehicle_document_view_list"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='document_type']" position="after">
                <field name="document_type_id" optional="show"/>
                <field name="is_critical_document" widget="boolean" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- ===================================================================
         EXTEND DOCUMENT SEARCH: Add filters for critical/expiring
         Note: The base search view is commented out, creating standalone view.
         =================================================================== -->
    <record id="fleet_vehicle_document_search_view_compliance" model="ir.ui.view">
        <field name="name">fleet.vehicle.document.search.compliance</field>
        <field name="model">fleet.vehicle.document</field>
        <field name="arch" type="xml">
            <search string="Rechercher Documents">
                <field name="vehicle_id"/>
                <field name="document_type"/>
                <field name="document_type_id"/>
                <field name="document_number"/>
                <field name="responsible_id"/>
                <separator/>
                <filter string="Expirés" name="expired" domain="[('state','=','expired')]"/>
                <filter string="À Renouveler Bientôt" name="expiring_soon" domain="[('state','=','expiring_soon')]"/>
                <filter string="Valides" name="valid" domain="[('state','=','valid')]"/>
                <separator/>
                <filter name="critical" string="Documents Critiques" 
                        domain="[('is_critical_document', '=', True)]"/>
                <filter name="non_critical" string="Documents Non Critiques" 
                        domain="[('is_critical_document', '=', False)]"/>
                <separator/>
                <filter string="Mes Documents" name="my_documents" domain="[('responsible_id','=',uid)]"/>
                <separator/>
                <!-- <group expand="0" string="Grouper par">
                    <filter string="Véhicule" name="group_vehicle" context="{'group_by':'vehicle_id'}"/>
                    <filter string="Type Document (Legacy)" name="group_type" context="{'group_by':'document_type'}"/>
                    <filter name="group_type_id" string="Type de Document" 
                            context="{'group_by': 'document_type_id'}"/>
                    <filter name="group_critical" string="Criticité" 
                            context="{'group_by': 'is_critical_document'}"/>
                    <filter string="État" name="group_state" context="{'group_by':'state'}"/>
                    <filter string="Responsable" name="group_responsible" context="{'group_by':'responsible_id'}"/>
                </group> -->
            </search>
        </field>
    </record>

</odoo>
